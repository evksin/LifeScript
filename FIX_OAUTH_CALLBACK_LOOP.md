# Исправление бесконечного цикла OAuth callback

## Проблема:

После выбора аккаунта Google происходит возврат к форме входа вместо редиректа на `/dashboard`.

## Что исправлено:

1. **Улучшен callback `redirect`:**

   - Теперь предотвращает редирект на `/login` после успешной авторизации
   - Всегда редиректит на `/dashboard` после успешного входа

2. **Добавлено логирование:**

   - В development режиме будут видны логи в консоли сервера
   - Это поможет понять, что происходит при обработке callback

3. **Улучшена обработка авторизованного пользователя:**
   - Если пользователь уже авторизован, форма не показывается

## Главная причина проблемы:

**Redirect URI не совпадает** с тем, что в Google Console, или **сессия не создается** после callback.

## Критическая проверка:

### 1. Проверьте Redirect URI в Google Console

1. Откройте [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Найдите ваш OAuth 2.0 Client ID
3. Проверьте раздел **"Authorized redirect URIs"**

**Должны быть ТОЧНО такие URL:**

Для локального хоста:

```
http://localhost:3000/api/auth/callback/google
```

Для Vercel:

```
https://life-script-swart.vercel.app/api/auth/callback/google
```

⚠️ **КРИТИЧНО:**

- URL должен быть **ТОЧНО** таким же (без лишних слешей, без пробелов)
- `http://` для localhost, `https://` для Vercel
- После изменения подождите 2-3 минуты

### 2. Проверьте базу данных

Убедитесь, что:

- Миграции применены: `npm run db:migrate`
- Таблицы `users`, `accounts`, `sessions` существуют
- База данных доступна

**Проверка:**

```powershell
npx prisma studio
```

Откройте таблицы и проверьте, создаются ли пользователи после попытки входа.

### 3. Проверьте переменные окружения

**Локально:**

```powershell
Get-Content .env.local | Select-String -Pattern "GOOGLE|AUTH|DATABASE"
```

**На Vercel:**

- Vercel Dashboard → Settings → Environment Variables
- Убедитесь, что все переменные добавлены для **Production**

### 4. Проверьте логи

**Локально:**

- Проверьте терминал, где запущен `npm run dev`
- После попытки входа должны появиться логи:
  - `[NextAuth] signIn callback: ...`
  - `[NextAuth] redirect callback: ...`

**На Vercel:**

- Vercel Dashboard → Deployments → последний деплой → Logs
- Ищите ошибки при обработке callback

## Диагностика:

1. **Проверьте URL после выбора аккаунта:**

   - После выбора аккаунта Google посмотрите на URL в браузере
   - Должен быть редирект на `/api/auth/callback/google?code=...`
   - Если URL другой - проблема с redirect URI

2. **Проверьте сессию:**

   - После callback откройте: `/api/auth/session`
   - Должна вернуться информация о пользователе
   - Если пусто - сессия не создается

3. **Проверьте базу данных:**
   - После попытки входа проверьте таблицы `users` и `sessions`
   - Должен создаться пользователь и сессия

## Возможные причины:

1. **Redirect URI не совпадает** (самая частая причина)
2. **База данных недоступна** или таблицы не созданы
3. **PrismaAdapter не работает** - не создает пользователя/сессию
4. **AUTH_SECRET разный** на локальном и Vercel
5. **Ошибка в callback обработке** - проверьте логи сервера

## Что делать:

1. ✅ Проверьте redirect URI в Google Console
2. ✅ Убедитесь, что миграции применены
3. ✅ Проверьте переменные окружения
4. ✅ Проверьте логи сервера
5. ✅ Проверьте базу данных (создаются ли пользователи)

После исправления redirect URI и пересборки проекта на Vercel проблема должна решиться.
